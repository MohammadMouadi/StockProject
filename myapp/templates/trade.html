{% extends "base.html" %}


{% block content %}


<form method="post" action="{% url 'trade' %}">
    <label for="stock_selector">Stock Symbol</label>
    <select name="stock_selector" id="stock_selector" onchange="get_stock_price()">
        {% for stock in stock_list %}
        <option value="{{ stock.symbol }}">{{ stock.symbol }}</option>
        {% endfor %}
    </select>
    <label id="stock_label"></label>
    <br>
    <label for="number_of_stocks">Number of Stocks</label>
    <input type="number" id="number_of_stocks" name="number_of_stocks"><br>
    <input type="submit" id="buy" name="buy" value="Buy">
    <input type="submit" id="sell" name="sell" value="Sell">
</form>


{%if request.method == 'POST' %}
{% if error %}
<p>error! {{ error }}</p>
{% else  %}
<p>Operation succeeded</p>
{% endif %}
{% endif %}

<canvas id="stockChart" height="100" ></canvas>

{% endblock %}

{% block scripts %}
<script>


 function get_stock_price() {
    draw_figure()
    let selector_value = $("#stock_selector").find(":selected").text();
    let url = "/stock_info/" + selector_value;
    $.get( url, function( data ) {
  $("#stock_label").text(data.price+"$")
});
 }

$(document).ready(function () {
get_stock_price()
});
        var myLineChart;
        function draw_figure() {

            if (myLineChart != null){
                myLineChart.destroy()
            }



            let selector_value = $("#stock_selector").find(":selected").text();
            let url = "/historic/" + selector_value;

            $.get(
                url,
                function (data) {
                    historic_data = data.data.sort(function (a, b) {
                        return a.date - b.date;
                    });


                        var ctxL = document.getElementById("stockChart").getContext('2d');
                        ctxL.width = 100
                        ctxL.height = 100

                        myLineChart = new Chart(ctxL, {
                            type: 'line',
                            data: {
                                labels: historic_data.map(d => d.label),
                                datasets: [
                                    {
                                        label: selector_value,
                                        data: historic_data.map(d => d.close),
                                        backgroundColor: [
                                            'rgba(105, 60, 50, .2)',
                                        ],
                                        borderColor: [
                                            'rgba(200, 50, 200, .7)',
                                        ],
                                        borderWidth: 2
                                    }

                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }

                        });
                });
        }

</script>

{% endblock %}